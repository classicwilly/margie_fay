import { test, expect } from './playwright-fixtures';
import { ensureAppView, retryClick } from './helpers/retryHelpers';
import applyAiStub from './helpers/aiStub';

test('Admin redemption flow — mark reward as fulfilled @smoke', async ({ page, storageKey }) => {
  test.setTimeout(120_000);
  const testInfo = test.info();
  const shouldTrace = !!process.env.WONKY_E2E_TRACE_TESTS || (!!process.env.CI && testInfo.retry > 0);
  if (shouldTrace) await page.context().tracing.start({ screenshots: true, snapshots: true });
  // Ensure we start with a clean seed key to avoid cross-test contamination,
  // then seed the app with redeemed reward so GameMaster sees a pending redemption.
  await page.addInitScript((seedKey) => {
    try { window.localStorage.removeItem(seedKey as string); } catch (e) { /* ignore */ }
    try { delete (window as any).__WONKY_TEST_STICKY_VIEW__; } catch (e) { /* ignore */ }
    try { ((window as any).__WONKY_TEST_STICKY_VIEW__ = undefined); } catch (e) { /* ignore */ }
    try { window.localStorage.removeItem('__WONKY_TEST_STICKY_VIEW__'); } catch (e) { /* ignore */ }
    try { delete (window as any).__E2E_FORCE_VIEW__; } catch (e) { /* ignore */ }
    try { ((window as any).__E2E_FORCE_VIEW__ = undefined); } catch (e) { /* ignore */ }
  }, storageKey);

  // Allow deterministic E2E initial state for the app so header rendering
  // doesn't race with seeding. This object will be applied by the
  // AppStateProvider before the first render when running E2E.
  await page.addInitScript((init) => {
    try { (window as any).__WONKY_TEST_INITIALIZE__ = init; } catch (e) { /* ignore */ }
  }, { dashboardType: 'william', view: 'game-master-dashboard', initialSetupComplete: true });

  // Force the app to initialize in the Game Master dashboard for E2E so the
  // test doesn't race with header seeding and navigation changes.
  await page.addInitScript(() => { try { (window as any).__E2E_FORCE_VIEW__ = 'game-master-dashboard'; } catch (e) { /* ignore */ } });

  await page.addInitScript((seedKey) => {
    try {
          try { (window as any).__E2E_STORAGE_KEY__ = seedKey as string; } catch (e) { /* ignore */ }
          const state = JSON.parse(window.localStorage.getItem(seedKey as string) || '{}');
      // Set a redeemed reward for Willow and use the admin's dashboard to access Game Master
      // NOTE: Game Master dashboard is only visible for `william` dashboardType
      state.redeemedRewards = state.redeemedRewards || { willow: [], sebastian: [] };
      // Use a generic persona for the seeded redemption. We prefer to avoid
      // hard-coding `willow` in selectors later by deriving the persona from
      // the runtime app state where possible.
      state.redeemedRewards.willow = [5]; // threshold 5
      state.dashboardType = state.dashboardType || 'william';
      // Mark onboarding done for E2E so The Cockpit is visible immediately
      state.initialSetupComplete = true;
      // For this test we'll rely on explicit E2E initialization to set the view
      // so we don't force The Cockpit here (avoids a race with __WONKY_TEST_INITIALIZE__)
          window.localStorage.setItem(seedKey as string, JSON.stringify(state));
      try { (window as any).__PLAYWRIGHT_SKIP_DEV_BYPASS__ = true; } catch(e) { /* ignore */ }
        try { (window as any).__E2E_FORCE_GAMEMASTER__ = true; } catch(e) { /* ignore */ }\n      // Ensure AI is disabled for non-AI admin flows to keep tests deterministic\n      try { window.localStorage.setItem('wonky_flags', JSON.stringify({ aiEnabled: false })); } catch(e) { /* ignore */ }\n    } catch (e) { /* ignore */ }\n  });\n  // NOTE: We intentionally *do not* remove the seeded state here. Clearing\n  // the seeded state before the initial render can cause the AppStateProvider\n  // to lose the `dashboardType` and related flags — which makes admin menu\n  // items like Game Master Hub disappear. We'll clean the seed at the end of\n  // the test instead to avoid cross-test contamination while still ensuring\n  // the seed is present for the initial hydration.\n  // Ensure view is forced even if prior addInitScript removed the seed.\n  // (Already set by the seeding script above; keep this as a noop for clarity)\n  page.on('console', (msg) => console.log('PW_CONSOLE', msg.type(), msg.text()));\n  // Force the app to render the Game Master dashboard at load time to avoid\n  // races between header rendering and localStorage seeding.\n  await page.goto('/?force_e2e_view=game-master-dashboard', { waitUntil: 'load' });\n  // Early: if an E2E stub exists, force the GM view immediately and release\n  // the UI gate so tests can interact with the app deterministically.\n  try {\n    await page.evaluate(() => {\n      try { (window as any).__WONKY_TEST_FORCE_VIEW__('game-master-dashboard'); } catch (e) { /* ignore */ }\n      try { (window as any).__WONKY_TEST_READY__ = true; } catch (e) { /* ignore */ }\n    });\n    // Wait for the runtime app state to reflect the forced GM view\n    try { await page.waitForFunction(() => !!(window as any).appState && (window as any).appState.view === 'game-master-dashboard', null, { timeout: 3000 }); } catch (e) { /* ignore */ }\n    try { await page.waitForSelector('[data-testid=\"e2e-gate\"]', { state: 'detached', timeout: 3000 }); } catch (e) { /* ignore */ }\n  } catch (e) { /* ignore */ }\n  await page.waitForLoadState('networkidle');\n  // Diagnostic dump: print all E2E flags and persistent sticky values\n  try {\n    const flags = await page.evaluate(() => ({\n      init: (window as any).__WONKY_TEST_INITIALIZE__,\n      sticky: (window as any).__WONKY_TEST_STICKY_VIEW__,\n      stickyLS: window.localStorage.getItem('__WONKY_TEST_STICKY_VIEW__'),\n      e2eForce: (window as any).__E2E_FORCE_VIEW__,\n      blockDb: (window as any).__WONKY_TEST_BLOCK_DB__,\n      canUpdateDb: typeof (window as any).__WONKY_TEST_CAN_UPDATE_DB__ === 'function' ? (window as any).__WONKY_TEST_CAN_UPDATE_DB__() : null,\n      appView: (window as any).appState?.view,\n      appDashboard: (window as any).appState?.dashboardType,\n      visibleDropdown: window.localStorage.getItem('wonky-e2e-visible-dropdown'),\n    }));\n    console.log('WONKY_E2E_FLAGS_AT_LOAD', flags);\n  } catch (e) { console.warn('WONKY_E2E_FLAG_DUMP_FAILED', e); }\n  // Also collect provider-level E2E logs if present\n  try {\n    const logs = await page.evaluate(() => (window as any).__WONKY_E2E_LOG_GET__ ? (window as any).__WONKY_E2E_LOG_GET__() : null);\n    console.log('WONKY_E2E_LOG_AT_LOAD', logs);\n  } catch (e) { /* ignore */ }\n  \n  // Aggressively force the Game Master view via dispatch if any E2E\n  // APIs are present. This helps in CI where early hydration may have failed.\n  try {\n    await page.evaluate(() => {\n      try {\n        const dispatch = (window as any).__WONKY_TEST_DISPATCH__;\n        if (dispatch) {\n          dispatch({ type: 'SET_DASHBOARD_TYPE', payload: 'william' });\n          dispatch({ type: 'SET_VIEW', payload: 'game-master-dashboard' });\n        }\n      } catch (e) { /* ignore */ }\n    });\n  } catch (e) { /* ignore */ }\n  // If provider applied a sticky seeded view, wait for that signal before\n  // interacting with the UI so tests avoid races where the header shows\n  // The Cockpit while the provider is still transitioning.\n  try {\n    await page.waitForFunction(() => !!(window as any).__WONKY_TEST_STICKY_VIEW__, null, { timeout: 3000 });\n    const sticky = await page.evaluate(() => (window as any).__WONKY_TEST_STICKY_VIEW__);\n    console.log('WONKY_STICKY_VIEW', sticky);\n    try {\n      await page.waitForFunction(() => !!localStorage.getItem('__WONKY_TEST_STICKY_VIEW__'), null, { timeout: 3000 });\n      const stickyLS = await page.evaluate(() => window.localStorage.getItem('__WONKY_TEST_STICKY_VIEW__'));\n      console.log('WONKY_STICKY_VIEW_LS', stickyLS);\n    } catch (e) { /* ignore */ }\n    // Wait for deterministic DOM signal: E2E runtime view chip.\n    try {\n      await page.waitForSelector('[data-testid=\"e2e-runtime-view\"]', { timeout: 3000 });\n      const e2eViewText = await page.getByTestId('e2e-runtime-view').innerText();\n      console.log('WONKY_E2E_RUNTIME_VIEW', e2eViewText);\n      // Assert it shows our seeded Game Master view when william/admin is seeded\n      if (sticky === 'game-master-dashboard' || (await page.evaluate(() => (window as any).__WONKY_TEST_INITIALIZE__?.dashboardType === 'william')))\n        expect(e2eViewText).toContain('game-master-dashboard');\n    } catch (e) { /* ignore missing debug chip */ }\n  } catch (e) { /* ignore — fallback strategies below handle missing sticky flag */ }\n  // Defensive: if the seeded init did not land the Game Master view, force it\n  // synchronously using the test helper; useful in flaky CI scenarios.\n  try {\n    // Wait for the E2E force view helper (either stub or real implementation)\n    await page.waitForFunction(() => !!(window as any).__WONKY_TEST_FORCE_VIEW__, null, { timeout: 3000 });\n    await page.evaluate(() => { try { (window as any).__WONKY_TEST_FORCE_VIEW__('game-master-dashboard'); } catch (e) { /* ignore */ } });\n    // After calling the helper, prefer using the dispatch fallback to make sure\n    // the provider updates the state synchronously if the helper didn't.\n    try {\n      await page.waitForFunction(() => !!(window as any).__WONKY_TEST_DISPATCH__, null, { timeout: 2000 });\n      await page.evaluate(() => {\n        try {\n          (window as any).__WONKY_TEST_DISPATCH__({ type: 'SET_DASHBOARD_TYPE', payload: 'william' });\n          (window as any).__WONKY_TEST_DISPATCH__({ type: 'SET_VIEW', payload: 'game-master-dashboard' });\n        } catch (e) { /* ignore */ }\n      });\n    } catch (e) { /* ignore */ }\n  } catch (e) { /* ignore */ }\n  try {\n    const debug = await page.evaluate(() => ({ e2eForce: (window as any).__E2E_FORCE_VIEW__, testInit: (window as any).__WONKY_TEST_INITIALIZE__, appState: (window as any).appState }));\n    console.log('WONKY_POST_FORCE_DEBUG', debug);\n    try { const logs = await page.evaluate(() => (window as any).__WONKY_E2E_LOG_GET__ ? (window as any).__WONKY_E2E_LOG_GET__() : null); console.log('WONKY_E2E_LOG_AFTER_FORCE', logs); } catch (e) { /* ignore */ }\n    try { const logs = await page.evaluate(() => (window as any).__WONKY_E2E_LOG_GET__ ? (window as any).__WONKY_E2E_LOG_GET__() : null); console.log('WONKY_E2E_LOG_AFTER_FORCE', logs); } catch (e) { /* ignore */ }\n  } catch (e) { /* ignore */ }\n  // Debug seeded state and app view to diagnose why the menu doesn't show Game Master Hub\n  try {\n    const seeded = await page.evaluate(() => window.localStorage.getItem((window as any).__E2E_STORAGE_KEY__ || 'wonky-sprout-os-state'));\n    console.log('WONKY_SEEDED_STATE_RAW', seeded);\n    const appView = await page.evaluate(() => (window as any).appState);\n    console.log('WONKY_RUNTIME_APPSTATE', appView);\n    const e2eForce = await page.evaluate(() => (window as any).__E2E_FORCE_VIEW__ || null);\n    console.log('WONKY_RUNTIME_E2E_FORCE_VIEW', e2eForce);\n    const headerDebug = await page.evaluate(() => window.localStorage.getItem('wonky-e2e-visible-dropdown'));\n    console.log('WONKY_HEADER_VISIBLE_DROPDOWN_AFTER_GOTO', headerDebug);\n  } catch (e) {\n    console.warn('WONKY_DEBUG_LOG_FAILED', e);\n  }\n  // Once the header debug key shows the admin menu, allow DB updates to avoid\n  // test flakiness from late DB snapshots overwriting seeded state.\n  try {\n    const header = await page.evaluate(() => window.localStorage.getItem('wonky-e2e-visible-dropdown'));\n    if (header && header.includes('game-master')) {\n      // Release the E2E gate so tests can interact with the UI deterministically\n      try { await page.evaluate(() => { (window as any).__WONKY_TEST_READY__ = true; }); } catch (e) { /* ignore */ }\n\n      try { await page.evaluate(() => (window as any).__WONKY_TEST_ALLOW_DB_UPDATES__(true)); } catch (e) { /* ignore */ }\n      console.log('WONKY_ALLOW_DB_UPDATES_AFTER_HEADER');\n      try { const logs = await page.evaluate(() => (window as any).__WONKY_E2E_LOG_GET__ ? (window as any).__WONKY_E2E_LOG_GET__() : null); console.log('WONKY_E2E_LOG_AFTER_ALLOW', logs); } catch (e) { /* ignore */ }\n      try { const logs = await page.evaluate(() => (window as any).__WONKY_E2E_LOG_GET__ ? (window as any).__WONKY_E2E_LOG_GET__() : null); console.log('WONKY_E2E_LOG_AFTER_ALLOW', logs); } catch (e) { /* ignore */ }\n    }\n  } catch (e) { /* ignore */ }\n  // Read the header debug key (visible dropdown) so we can assert whether Game Master\n  // is visible to this session before trying the UI.\n  try {\n    const headerDebug = await page.evaluate(() => window.localStorage.getItem('wonky-e2e-visible-dropdown'));\n    console.log('WONKY_HEADER_VISIBLE_DROPDOWN', headerDebug);\n  } catch (e) { console.warn('WONKY_HEADER_DEBUG_FAILED', e); }\n  // Debug: surface the last error captured by ErrorBoundary to the test logs\n  try {\n    const lastErr = await page.evaluate(() => (window as any).__WONKY_LAST_ERROR__ || null);\n    const lastErrRaw = await page.evaluate(() => window.localStorage.getItem('wonky-last-error'));\n    console.log('WONKY_LAST_ERROR_RAW', lastErrRaw);\n    const domError = await page.getByTestId('wonky-last-error').allInnerTexts();\n    if (domError && domError.length > 0) {\n      throw new Error(`E2E Captured error from ErrorBoundary: ${domError.join('\\n')}`);\n    }\n    // and Vitest output include the stack for debugging.\n    expect(lastErr).toBeNull();\n  } catch (e) { console.warn('Could not read WONKY_LAST_ERROR from page', e); }\n\n  // Navigate to Game Master Dashboard via The Cockpit menu\n  await expect(page.getByRole('banner')).toBeVisible({ timeout: 10000 });\n  let nav = page.getByTestId('nav-command-center');\n  if ((await nav.count()) === 0) nav = page.getByRole('button', { name: /The Cockpit|Admin Dashboard|Admin/i });\n  // Historically tests clicked The Cockpit nav to reach admin flows,\n  // but that causes ordering races. Ensure the app view is explicitly the\n  // Game Master dashboard which the rest of the test asserts against.\n  try {\n    await ensureAppView(page, 'game-master-dashboard');\n  } catch (e) {\n    // Fall back to clicking the nav button — sometimes this is needed on\n    // older builds where force view doesn't take; this is a last-resort.\n    // eslint-disable-next-line no-console\n    console.warn('Could not ensure game-master-dashboard, falling back to The Cockpit nav', e);\n    await retryClick(nav, { tries: 3 });\n  }\n\n  // Ensure The Cockpit is visible and open Game Master Hub\n  let commandCenterVisible = false;\n  try {\n    // Prefer role-based lookup for The Cockpit since the nav button may not\n    // include a data-testid on all layouts; fallback to testid if present.\n    const ccBtn = page.getByRole('button', { name: /The Cockpit|Admin Dashboard|Admin/i });\n    await expect(ccBtn).toBeVisible({ timeout: 5000 });\n    await retryClick(ccBtn, { tries: 3 });\n    await page.waitForLoadState('networkidle');\n    commandCenterVisible = true;\n  } catch (err) {\n    let nav = page.getByRole('button', { name: /The Cockpit/i });\n    if (await nav.count()) {\n      await retryClick(nav, { tries: 3 });\n      await page.waitForLoadState('networkidle');\n      try {\n        await expect(page.getByTestId('nav-command-center')).toBeVisible({ timeout: 5000 });\n        commandCenterVisible = true;\n      } catch (err) {}\n    }\n  }\n  if (!commandCenterVisible) {\n    try {\n      // Re-seed state for this worker with `command-center` and reload\n      await page.evaluate((key) => {\n        try {\n          const state = JSON.parse(window.localStorage.getItem(key) || '{}');\n          state.dashboardType = 'william';\n          state.view = 'game-master-dashboard';\n          state.initialSetupComplete = true;\n          (window as any).__E2E_FORCE_VIEW__ = 'game-master-dashboard';\n          window.localStorage.setItem(key, JSON.stringify(state));\n        } catch (e) { /* ignore */ }\n      }, storageKey);\n      await page.reload({ waitUntil: 'load' });\n      await page.waitForLoadState('networkidle');\n      await ensureAppView(page, 'command-center');\n      const ccNav = page.getByTestId('nav-command-center');\n      await retryClick(ccNav, { tries: 3 });\n      await expect(ccNav).toBeVisible({ timeout: 5000 });\n      await retryClick(ccNav, { tries: 3 });\n      commandCenterVisible = true;\n    } catch (err) {\n      await page.screenshot({ path: 'command_center_not_loaded.png' });\n      throw new Error('The Cockpit not loaded: nav-command-center not visible');\n    }\n  }\n  // Extra debug dump to ensure we know which E2E signals are present\n  try {\n    const debug = await page.evaluate(() => ({\n      e2eInit: (window as any).__WONKY_TEST_INITIALIZE__,\n      e2eForce: (window as any).__E2E_FORCE_VIEW__,\n      sticky: (window as any).__WONKY_TEST_STICKY_VIEW__,\n      stickyLS: window.localStorage.getItem('__WONKY_TEST_STICKY_VIEW__'),\n      domE2eView: document.querySelector('[data-testid=\"e2e-runtime-view\"]') ? (document.querySelector('[data-testid=\"e2e-runtime-view\"]') as HTMLElement).innerText : null,\n      docE2eAttr: (document.documentElement as any)?.dataset?.e2eView || null,\n      canUpdateDb: typeof (window as any).__WONKY_TEST_CAN_UPDATE_DB__ === 'function' ? (window as any).__WONKY_TEST_CAN_UPDATE_DB__() : null,\n      e2eLog: (window as any).__WONKY_E2E_LOG_GET__ ? (window as any).__WONKY_E2E_LOG_GET__() : null,\n      appState: (window as any).appState,\n    }));\n    console.log('WONKY_EXTRA_DEBUG_AT_OPEN_GAME_MASTER', debug);\n  } catch(e) { /* ignore */ }\n  // If there is a top-level Game Master nav (E2E-facing shortcut), use it.\n  // This makes the test deterministic when the admin seed is present.\n  try {\n    const gmTop = page.getByTestId('nav-game-master');\n    if ((await gmTop.count()) > 0) {\n      await retryClick(gmTop, { tries: 3 });\n      // Ensure we land on the Game Master view\n      await ensureAppView(page, 'game-master-dashboard');\n    }\n  } catch (e) { /* ignore — fall back to system menu */ }\n  // Wait for header visible dropdown debug info to include Game Master\n  // This ensures the test doesn't race with header rendering logic.\n  try {\n    await page.waitForFunction((k) => {\n      try {\n        const raw = window.localStorage.getItem(k as string);\n        if (!raw) return false;\n        const parsed = JSON.parse(raw);\n        return Array.isArray(parsed.items) && parsed.items.includes('game-master');\n      } catch (e) { return false; }\n    }, 'wonky-e2e-visible-dropdown', { timeout: 3000 });\n  } catch (e) {\n    // No-op — fallbacks below will try system menu and dispatch\n  }\n  // Open Game Master Hub\n  try {\n    const gmHub = page.getByText('Game Master Hub');\n    if ((await gmHub.count()) > 0) {\n      await retryClick(gmHub, { tries: 3 });\n    } else {\n      throw new Error('Game Master Hub not present');\n    }\n  } catch (err) {\n    // fallback: open via system menu\n    try {\n      let systemBtn = page.getByTestId('nav-system');\n      if (await systemBtn.count()) {\n        await retryClick(systemBtn, { tries: 3 });\n        await page.getByRole('menu').waitFor({ state: 'visible', timeout: 5000 });\n        const gmMenu = page.getByRole('menuitem', { name: /Game Master Hub/i });\n        await retryClick(gmMenu, { tries: 3 });\n      }\n    } catch (e) {\n      // If clicking the System menu or its items fails, swallow the error\n      // and continue to the dispatch fallback below.\n      console.warn('Could not open Game Master via System menu', e);\n    }\n    // If the header still doesn't show Game Master Hub, call the E2E test dispatch\n    // to set the dashboard type and open the Game Master dashboard directly.\n    try {\n      const didDispatch = await page.evaluate(() => {\n        try {\n          const dispatch = (window as any).__WONKY_TEST_DISPATCH__;\n          if (!dispatch) return false;\n          // Ensure the allowed dashboard type for the Game Master is set\n          dispatch({ type: 'SET_DASHBOARD_TYPE', payload: 'william' });\n          // Open the Game Master dashboard directly\n          // If tests have an active E2E forced view, clear it so dispatch\n          // can take effect (AppContent prefers __E2E_FORCE_VIEW__ over\n          // app state when present). We set it to undefined rather than\n          // reload so we don't lose other runtime state.\n          if ((window as any).__E2E_FORCE_VIEW__ === 'command-center') {\n            try { (window as any).__E2E_FORCE_VIEW__ = undefined; } catch (e) { /* ignore */ }\n          }\n          dispatch({ type: 'SET_VIEW', payload: 'game-master-dashboard' });\n          return true;\n        } catch (e) { return false; }\n      });\n      // Debug: whether dispatch exists and what view is set on the appState\n      try {\n        const debug = await page.evaluate(() => ({ testDispatch: !!(window as any).__WONKY_TEST_DISPATCH__, view: (window as any).appState?.view }));\n        console.log('WONKY_FALLBACK_DEBUG', debug);\n      } catch (e) { console.warn('FALLBACK_DEBUG_FAILED', e); }\n      if (didDispatch) {\n        // After dispatch, ensure the runtime app state reflects the new view\n        const newView = await page.evaluate(() => (window as any).appState?.view || null);\n        console.log('WONKY_FALLBACK_VIEW_AFTER_DISPATCH', newView);\n        // Release the E2E gate after dispatch forces the Game Master view so\n        // the test can interact with the UI. This covers cases where the\n        // header debug never included the Game Master item but the dispatch\n        // fallback still succeeded.\n        try { await page.evaluate(() => { (window as any).__WONKY_TEST_READY__ = true; }); } catch (e) { /* ignore */ }\n        // Wait for the admin content to become visible\n        try {\n          try { await page.evaluate(() => { (window as any).__WONKY_TEST_READY__ = true; }); } catch (e) { /* ignore */ }\n          try { await page.waitForSelector('[data-testid=\"e2e-gate\"]', { state: 'detached', timeout: 3000 }); } catch (e) { /* ignore */ }\n          await expect(page.getByTestId('pending-redemptions')).toBeVisible({ timeout: 10000 });\n          // Allow DB updates once we've verified the seeded content is visible\n          try { await page.evaluate(() => { try { (window as any).__WONKY_TEST_ALLOW_DB_UPDATES__(true); } catch (e) { /* ignore */ } }); } catch(e) { /* ignore */ }\n        } catch (e) {\n          // If the dispatch route didn't reveal the Game Master dashboard,\n          // fall back to reseeding the storage key and reloading the page.\n          try {\n            await page.evaluate((key) => {\n              try {\n                const state = JSON.parse(window.localStorage.getItem(key as string) || '{}');\n                state.dashboardType = 'william';\n                state.view = 'game-master-dashboard';\n                state.initialSetupComplete = true;\n                window.localStorage.setItem(key, JSON.stringify(state));\n              } catch (e) { /* ignore */ }\n            }, storageKey);\n            // Ensure the forced view is applied when the page initializes.\n            await page.addInitScript(() => { try { (window as any).__E2E_FORCE_VIEW__ = 'game-master-dashboard'; } catch (e) { /* ignore */ } });\n            await page.reload({ waitUntil: 'load' });\n            // After reload, the initial addInitScript might set __E2E_FORCE_VIEW__\n            // back to 'command-center' — override it here to force the admin\n            // view for this test run and trigger a re-render.\n            try {\n              await page.evaluate(() => { try { (window as any).__E2E_FORCE_VIEW__ = 'game-master-dashboard'; } catch(e) { /* ignore */ } });\n            } catch(e) { /* ignore */ }\n            await page.waitForLoadState('networkidle');\n            // Ensure the app view is the Game Master dashboard before proceeding\n            try { await ensureAppView(page, 'game-master-dashboard', 5); } catch (_) { /* ignore */ }\n            try { await page.evaluate(() => { (window as any).__WONKY_TEST_READY__ = true; }); } catch (e) { /* ignore */ }\n            try { await page.waitForSelector('[data-testid=\"e2e-gate\"]', { state: 'detached', timeout: 3000 }); } catch (e) { /* ignore */ }\n            await expect(page.getByTestId('pending-redemptions')).toBeVisible({ timeout: 10000 });\n          } catch (err) { /* final fallback ignored */ }\n        }\n      }\n    } catch (e) { /* ignore dispatch fallback errors */ }\n  }\n\n  // Ensure the Redemption Hub shows the pending item\n  try { await page.evaluate(() => { (window as any).__WONKY_TEST_READY__ = true; }); } catch (e) { /* ignore */ }\n  try { await page.waitForSelector('[data-testid=\"e2e-gate\"]', { state: 'detached', timeout: 3000 }); } catch (e) { /* ignore */ }\n  await expect(page.getByTestId('pending-redemptions')).toBeVisible({ timeout: 10000 });\n  try { await page.evaluate(() => { try { (window as any).__WONKY_TEST_ALLOW_DB_UPDATES__(true); } catch (e) { /* ignore */ } }); } catch(e) { /* ignore */ }\n  // Enter a note and click 'Mark as Fulfilled' (use stable testids)\n  // Determine the persona who has the pending redemption so we don't rely on\n  // literal 'willow' in the test. We check `window.appState` (exposed by the\n  // App) first; fallback to localStorage if not set.\n  const persona = await page.evaluate(() => {\n    try {\n      const key = (window as any).__E2E_STORAGE_KEY__ || 'wonky-sprout-os-state';\n      const state = (window as any).appState || JSON.parse(window.localStorage.getItem(key) || '{}');\n      if (state && state.redeemedRewards) {\n        for (const key of Object.keys(state.redeemedRewards)) {\n          if (Array.isArray(state.redeemedRewards[key]) && state.redeemedRewards[key].includes(5)) return key;\n        }\n      }\n    } catch (e) { /* ignore */ }\n    return 'willow';\n  });\n  const redemptionId = `${persona}-5`;\n  const pendingNote = page.getByTestId(`redemption-note-${redemptionId}`);\n  await pendingNote.fill('Fulfilled by admin in test');\n  const pendingBtn = page.getByTestId(`mark-fulfilled-${redemptionId}`);\n  await pendingBtn.click();\n\n  // The fulfillment should appear in the Fulfillment Log\n  await expect(page.getByText(/Fulfillment Log/)).toBeVisible();\n  await expect(page.locator('text=Fulfilled by admin in test')).toBeVisible({ timeout: 10000 });\n  try {\n    if (shouldTrace) await page.context().tracing.stop({ path: 'trace-redemption_admin.zip' });\n  } catch (e) { console.warn('Failed to stop tracing', e); }\n  // Cleanup the seeded state for this worker so following tests aren't affected\n  try { await page.evaluate((key) => { try { window.localStorage.removeItem(key as string); } catch (e) { /* ignore */ } }, storageKey); } catch (e) { /* ignore */ }\n});\n```import { test, expect } from './playwright-fixtures';
import { ensureAppView, retryClick } from './helpers/retryHelpers';
import applyAiStub from './helpers/aiStub';

test('Admin redemption flow — mark reward as fulfilled @smoke', async ({ page, storageKey }) => {
  test.setTimeout(120_000);
  const testInfo = test.info();
  const shouldTrace = !!process.env.WONKY_E2E_TRACE_TESTS || (!!process.env.CI && testInfo.retry > 0);
  if (shouldTrace) await page.context().tracing.start({ screenshots: true, snapshots: true });
  // Ensure we start with a clean seed key to avoid cross-test contamination,
  // then seed the app with redeemed reward so GameMaster sees a pending redemption.
  await page.addInitScript((seedKey) => {
    try { window.localStorage.removeItem(seedKey as string); } catch (e) { /* ignore */ }
    try { delete (window as any).__WONKY_TEST_STICKY_VIEW__; } catch (e) { /* ignore */ }
    try { ((window as any).__WONKY_TEST_STICKY_VIEW__ = undefined); } catch (e) { /* ignore */ }
    try { window.localStorage.removeItem('__WONKY_TEST_STICKY_VIEW__'); } catch (e) { /* ignore */ }
    try { delete (window as any).__E2E_FORCE_VIEW__; } catch (e) { /* ignore */ }
    try { ((window as any).__E2E_FORCE_VIEW__ = undefined); } catch (e) { /* ignore */ }
  }, storageKey);

  // Allow deterministic E2E initial state for the app so header rendering
  // doesn't race with seeding. This object will be applied by the
  // AppStateProvider before the first render when running E2E.
  await page.addInitScript((init) => {
    try { (window as any).__WONKY_TEST_INITIALIZE__ = init; } catch (e) { /* ignore */ }
  }, { dashboardType: 'william', view: 'game-master-dashboard', initialSetupComplete: true });

  // Force the app to initialize in the Game Master dashboard for E2E so the
  // test doesn't race with header seeding and navigation changes.
  await page.addInitScript(() => { try { (window as any).__E2E_FORCE_VIEW__ = 'game-master-dashboard'; } catch (e) { /* ignore */ } });

  await page.addInitScript((seedKey) => {
    try {
          try { (window as any).__E2E_STORAGE_KEY__ = seedKey as string; } catch (e) { /* ignore */ }
          const state = JSON.parse(window.localStorage.getItem(seedKey as string) || '{}');
      // Set a redeemed reward for Willow and use the admin's dashboard to access Game Master
      // NOTE: Game Master dashboard is only visible for `william` dashboardType
      state.redeemedRewards = state.redeemedRewards || { willow: [], sebastian: [] };
      // Use a generic persona for the seeded redemption. We prefer to avoid
      // hard-coding `willow` in selectors later by deriving the persona from
      // the runtime app state where possible.
      state.redeemedRewards.willow = [5]; // threshold 5
      state.dashboardType = state.dashboardType || 'william';
      // Mark onboarding done for E2E so The Cockpit is visible immediately
      state.initialSetupComplete = true;
      // For this test we'll rely on explicit E2E initialization to set the view
      // so we don't force The Cockpit here (avoids a race with __WONKY_TEST_INITIALIZE__)
          window.localStorage.setItem(seedKey as string, JSON.stringify(state));
      try { (window as any).__PLAYWRIGHT_SKIP_DEV_BYPASS__ = true; } catch(e) { /* ignore */ }
        try { (window as any).__E2E_FORCE_GAMEMASTER__ = true; } catch(e) { /* ignore */ }\n      // Ensure AI is disabled for non-AI admin flows to keep tests deterministic\n      try { window.localStorage.setItem('wonky_flags', JSON.stringify({ aiEnabled: false })); } catch(e) { /* ignore */ }\n    } catch (e) { /* ignore */ }\n  });\n  // NOTE: We intentionally *do not* remove the seeded state here. Clearing\n  // the seeded state before the initial render can cause the AppStateProvider\n  // to lose the `dashboardType` and related flags — which makes admin menu\n  // items like Game Master Hub disappear. We'll clean the seed at the end of\n  // the test instead to avoid cross-test contamination while still ensuring\n  // the seed is present for the initial hydration.\n  // Ensure view is forced even if prior addInitScript removed the seed.\n  // (Already set by the seeding script above; keep this as a noop for clarity)\n  page.on('console', (msg) => console.log('PW_CONSOLE', msg.type(), msg.text()));\n  // Force the app to render the Game Master dashboard at load time to avoid\n  // races between header rendering and localStorage seeding.\n  await page.goto('/?force_e2e_view=game-master-dashboard', { waitUntil: 'load' });\n  // Early: if an E2E stub exists, force the GM view immediately and release\n  // the UI gate so tests can interact with the app deterministically.\n  try {\n    await page.evaluate(() => {\n      try { (window as any).__WONKY_TEST_FORCE_VIEW__('game-master-dashboard'); } catch (e) { /* ignore */ }\n      try { (window as any).__WONKY_TEST_READY__ = true; } catch (e) { /* ignore */ }\n    });\n    // Wait for the runtime app state to reflect the forced GM view\n    try { await page.waitForFunction(() => !!(window as any).appState && (window as any).appState.view === 'game-master-dashboard', null, { timeout: 3000 }); } catch (e) { /* ignore */ }\n    try { await page.waitForSelector('[data-testid=\"e2e-gate\"]', { state: 'detached', timeout: 3000 }); } catch (e) { /* ignore */ }\n  } catch (e) { /* ignore */ }\n  await page.waitForLoadState('networkidle');\n  // Diagnostic dump: print all E2E flags and persistent sticky values\n  try {\n    const flags = await page.evaluate(() => ({\n      init: (window as any).__WONKY_TEST_INITIALIZE__,\n      sticky: (window as any).__WONKY_TEST_STICKY_VIEW__,\n      stickyLS: window.localStorage.getItem('__WONKY_TEST_STICKY_VIEW__'),\n      e2eForce: (window as any).__E2E_FORCE_VIEW__,\n      blockDb: (window as any).__WONKY_TEST_BLOCK_DB__,\n      canUpdateDb: typeof (window as any).__WONKY_TEST_CAN_UPDATE_DB__ === 'function' ? (window as any).__WONKY_TEST_CAN_UPDATE_DB__() : null,\n      appView: (window as any).appState?.view,\n      appDashboard: (window as any).appState?.dashboardType,\n      visibleDropdown: window.localStorage.getItem('wonky-e2e-visible-dropdown'),\n    }));\n    console.log('WONKY_E2E_FLAGS_AT_LOAD', flags);\n  } catch (e) { console.warn('WONKY_E2E_FLAG_DUMP_FAILED', e); }\n  // Also collect provider-level E2E logs if present\n  try {\n    const logs = await page.evaluate(() => (window as any).__WONKY_E2E_LOG_GET__ ? (window as any).__WONKY_E2E_LOG_GET__() : null);\n    console.log('WONKY_E2E_LOG_AT_LOAD', logs);\n  } catch (e) { /* ignore */ }\n  \n  // Aggressively force the Game Master view via dispatch if any E2E\n  // APIs are present. This helps in CI where early hydration may have failed.\n  try {\n    await page.evaluate(() => {\n      try {\n        const dispatch = (window as any).__WONKY_TEST_DISPATCH__;\n        if (dispatch) {\n          dispatch({ type: 'SET_DASHBOARD_TYPE', payload: 'william' });\n          dispatch({ type: 'SET_VIEW', payload: 'game-master-dashboard' });\n        }\n      } catch (e) { /* ignore */ }\n    });\n  } catch (e) { /* ignore */ }\n  // If provider applied a sticky seeded view, wait for that signal before\n  // interacting with the UI so tests avoid races where the header shows\n  // The Cockpit while the provider is still transitioning.\n  try {\n    await page.waitForFunction(() => !!(window as any).__WONKY_TEST_STICKY_VIEW__, null, { timeout: 3000 });\n    const sticky = await page.evaluate(() => (window as any).__WONKY_TEST_STICKY_VIEW__);\n    console.log('WONKY_STICKY_VIEW', sticky);\n    try {\n      await page.waitForFunction(() => !!localStorage.getItem('__WONKY_TEST_STICKY_VIEW__'), null, { timeout: 3000 });\n      const stickyLS = await page.evaluate(() => window.localStorage.getItem('__WONKY_TEST_STICKY_VIEW__'));\n      console.log('WONKY_STICKY_VIEW_LS', stickyLS);\n    } catch (e) { /* ignore */ }\n    // Wait for deterministic DOM signal: E2E runtime view chip.\n    try {\n      await page.waitForSelector('[data-testid=\"e2e-runtime-view\"]', { timeout: 3000 });\n      const e2eViewText = await page.getByTestId('e2e-runtime-view').innerText();\n      console.log('WONKY_E2E_RUNTIME_VIEW', e2eViewText);\n      // Assert it shows our seeded Game Master view when william/admin is seeded\n      if (sticky === 'game-master-dashboard' || (await page.evaluate(() => (window as any).__WONKY_TEST_INITIALIZE__?.dashboardType === 'william')))\n        expect(e2eViewText).toContain('game-master-dashboard');\n    } catch (e) { /* ignore missing debug chip */ }\n  } catch (e) { /* ignore — fallback strategies below handle missing sticky flag */ }\n  // Defensive: if the seeded init did not land the Game Master view, force it\n  // synchronously using the test helper; useful in flaky CI scenarios.\n  try {\n    // Wait for the E2E force view helper (either stub or real implementation)\n    await page.waitForFunction(() => !!(window as any).__WONKY_TEST_FORCE_VIEW__, null, { timeout: 3000 });\n    await page.evaluate(() => { try { (window as any).__WONKY_TEST_FORCE_VIEW__('game-master-dashboard'); } catch (e) { /* ignore */ } });\n    // After calling the helper, prefer using the dispatch fallback to make sure\n    // the provider updates the state synchronously if the helper didn't.\n    try {\n      await page.waitForFunction(() => !!(window as any).__WONKY_TEST_DISPATCH__, null, { timeout: 2000 });\n      await page.evaluate(() => {\n        try {\n          (window as any).__WONKY_TEST_DISPATCH__({ type: 'SET_DASHBOARD_TYPE', payload: 'william' });\n          (window as any).__WONKY_TEST_DISPATCH__({ type: 'SET_VIEW', payload: 'game-master-dashboard' });\n        } catch (e) { /* ignore */ }\n      });\n    } catch (e) { /* ignore */ }\n  } catch (e) { /* ignore */ }\n  try {\n    const debug = await page.evaluate(() => ({ e2eForce: (window as any).__E2E_FORCE_VIEW__, testInit: (window as any).__WONKY_TEST_INITIALIZE__, appState: (window as any).appState }));\n    console.log('WONKY_POST_FORCE_DEBUG', debug);\n    try { const logs = await page.evaluate(() => (window as any).__WONKY_E2E_LOG_GET__ ? (window as any).__WONKY_E2E_LOG_GET__() : null); console.log('WONKY_E2E_LOG_AFTER_FORCE', logs); } catch (e) { /* ignore */ }\n    try { const logs = await page.evaluate(() => (window as any).__WONKY_E2E_LOG_GET__ ? (window as any).__WONKY_E2E_LOG_GET__() : null); console.log('WONKY_E2E_LOG_AFTER_FORCE', logs); } catch (e) { /* ignore */ }\n  } catch (e) { /* ignore */ }\n  // Debug seeded state and app view to diagnose why the menu doesn't show Game Master Hub\n  try {\n    const seeded = await page.evaluate(() => window.localStorage.getItem((window as any).__E2E_STORAGE_KEY__ || 'wonky-sprout-os-state'));\n    console.log('WONKY_SEEDED_STATE_RAW', seeded);\n    const appView = await page.evaluate(() => (window as any).appState);\n    console.log('WONKY_RUNTIME_APPSTATE', appView);\n    const e2eForce = await page.evaluate(() => (window as any).__E2E_FORCE_VIEW__ || null);\n    console.log('WONKY_RUNTIME_E2E_FORCE_VIEW', e2eForce);\n    const headerDebug = await page.evaluate(() => window.localStorage.getItem('wonky-e2e-visible-dropdown'));\n    console.log('WONKY_HEADER_VISIBLE_DROPDOWN_AFTER_GOTO', headerDebug);\n  } catch (e) {\n    console.warn('WONKY_DEBUG_LOG_FAILED', e);\n  }\n  // Once the header debug key shows the admin menu, allow DB updates to avoid\n  // test flakiness from late DB snapshots overwriting seeded state.\n  try {\n    const header = await page.evaluate(() => window.localStorage.getItem('wonky-e2e-visible-dropdown'));\n    if (header && header.includes('game-master')) {\n      // Release the E2E gate so tests can interact with the UI deterministically\n      try { await page.evaluate(() => { (window as any).__WONKY_TEST_READY__ = true; }); } catch (e) { /* ignore */ }\n\n      try { await page.evaluate(() => (window as any).__WONKY_TEST_ALLOW_DB_UPDATES__(true)); } catch (e) { /* ignore */ }\n      console.log('WONKY_ALLOW_DB_UPDATES_AFTER_HEADER');\n      try { const logs = await page.evaluate(() => (window as any).__WONKY_E2E_LOG_GET__ ? (window as any).__WONKY_E2E_LOG_GET__() : null); console.log('WONKY_E2E_LOG_AFTER_ALLOW', logs); } catch (e) { /* ignore */ }\n      try { const logs = await page.evaluate(() => (window as any).__WONKY_E2E_LOG_GET__ ? (window as any).__WONKY_E2E_LOG_GET__() : null); console.log('WONKY_E2E_LOG_AFTER_ALLOW', logs); } catch (e) { /* ignore */ }\n    }\n  } catch (e) { /* ignore */ }\n  // Read the header debug key (visible dropdown) so we can assert whether Game Master\n  // is visible to this session before trying the UI.\n  try {\n    const headerDebug = await page.evaluate(() => window.localStorage.getItem('wonky-e2e-visible-dropdown'));\n    console.log('WONKY_HEADER_VISIBLE_DROPDOWN', headerDebug);\n  } catch (e) { console.warn('WONKY_HEADER_DEBUG_FAILED', e); }\n  // Debug: surface the last error captured by ErrorBoundary to the test logs\n  try {\n    const lastErr = await page.evaluate(() => (window as any).__WONKY_LAST_ERROR__ || null);\n    const lastErrRaw = await page.evaluate(() => window.localStorage.getItem('wonky-last-error'));\n    console.log('WONKY_LAST_ERROR_RAW', lastErrRaw);\n    const domError = await page.getByTestId('wonky-last-error').allInnerTexts();\n    if (domError && domError.length > 0) {\n      throw new Error(`E2E Captured error from ErrorBoundary: ${domError.join('\\n')}`);\n    }\n    // and Vitest output include the stack for debugging.\n    expect(lastErr).toBeNull();\n  } catch (e) { console.warn('Could not read WONKY_LAST_ERROR from page', e); }\n\n  // Navigate to Game Master Dashboard via The Cockpit menu\n  await expect(page.getByRole('banner')).toBeVisible({ timeout: 10000 });\n  let nav = page.getByTestId('nav-command-center');\n  if ((await nav.count()) === 0) nav = page.getByRole('button', { name: /The Cockpit|Admin Dashboard|Admin/i });\n  // Historically tests clicked The Cockpit nav to reach admin flows,\n  // but that causes ordering races. Ensure the app view is explicitly the\n  // Game Master dashboard which the rest of the test asserts against.\n  try {\n    await ensureAppView(page, 'game-master-dashboard');\n  } catch (e) {\n    // Fall back to clicking the nav button — sometimes this is needed on\n    // older builds where force view doesn't take; this is a last-resort.\n    // eslint-disable-next-line no-console\n    console.warn('Could not ensure game-master-dashboard, falling back to The Cockpit nav', e);\n    await retryClick(nav, { tries: 3 });\n  }\n\n  // Ensure The Cockpit is visible and open Game Master Hub\n  let commandCenterVisible = false;\n  try {\n    // Prefer role-based lookup for The Cockpit since the nav button may not\n    // include a data-testid on all layouts; fallback to testid if present.\n    const ccBtn = page.getByRole('button', { name: /The Cockpit|Admin Dashboard|Admin/i });\n    await expect(ccBtn).toBeVisible({ timeout: 5000 });\n    await retryClick(ccBtn, { tries: 3 });\n    await page.waitForLoadState('networkidle');\n    commandCenterVisible = true;\n  } catch (err) {\n    let nav = page.getByRole('button', { name: /The Cockpit/i });\n    if (await nav.count()) {\n      await retryClick(nav, { tries: 3 });\n      await page.waitForLoadState('networkidle');\n      try {\n        await expect(page.getByTestId('nav-command-center')).toBeVisible({ timeout: 5000 });\n        commandCenterVisible = true;\n      } catch (err) {}\n    }\n  }\n  if (!commandCenterVisible) {\n    try {\n      // Re-seed state for this worker with `command-center` and reload\n      await page.evaluate((key) => {\n        try {\n          const state = JSON.parse(window.localStorage.getItem(key) || '{}');\n          state.dashboardType = 'william';\n          state.view = 'game-master-dashboard';\n          state.initialSetupComplete = true;\n          (window as any).__E2E_FORCE_VIEW__ = 'game-master-dashboard';\n          window.localStorage.setItem(key, JSON.stringify(state));\n        } catch (e) { /* ignore */ }\n      }, storageKey);\n      await page.reload({ waitUntil: 'load' });\n      await page.waitForLoadState('networkidle');\n      await ensureAppView(page, 'command-center');\n      const ccNav = page.getByTestId('nav-command-center');\n      await retryClick(ccNav, { tries: 3 });\n      await expect(ccNav).toBeVisible({ timeout: 5000 });\n      await retryClick(ccNav, { tries: 3 });\n      commandCenterVisible = true;\n    } catch (err) {\n      await page.screenshot({ path: 'command_center_not_loaded.png' });\n      throw new Error('The Cockpit not loaded: nav-command-center not visible');\n    }\n  }\n  // Extra debug dump to ensure we know which E2E signals are present\n  try {\n    const debug = await page.evaluate(() => ({\n      e2eInit: (window as any).__WONKY_TEST_INITIALIZE__,\n      e2eForce: (window as any).__E2E_FORCE_VIEW__,\n      sticky: (window as any).__WONKY_TEST_STICKY_VIEW__,\n      stickyLS: window.localStorage.getItem('__WONKY_TEST_STICKY_VIEW__'),\n      domE2eView: document.querySelector('[data-testid=\"e2e-runtime-view\"]') ? (document.querySelector('[data-testid=\"e2e-runtime-view\"]') as HTMLElement).innerText : null,\n      docE2eAttr: (document.documentElement as any)?.dataset?.e2eView || null,\n      canUpdateDb: typeof (window as any).__WONKY_TEST_CAN_UPDATE_DB__ === 'function' ? (window as any).__WONKY_TEST_CAN_UPDATE_DB__() : null,\n      e2eLog: (window as any).__WONKY_E2E_LOG_GET__ ? (window as any).__WONKY_E2E_LOG_GET__() : null,\n      appState: (window as any).appState,\n    }));\n    console.log('WONKY_EXTRA_DEBUG_AT_OPEN_GAME_MASTER', debug);\n  } catch(e) { /* ignore */ }\n  // If there is a top-level Game Master nav (E2E-facing shortcut), use it.\n  // This makes the test deterministic when the admin seed is present.\n  try {\n    const gmTop = page.getByTestId('nav-game-master');\n    if ((await gmTop.count()) > 0) {\n      await retryClick(gmTop, { tries: 3 });\n      // Ensure we land on the Game Master view\n      await ensureAppView(page, 'game-master-dashboard');\n    }\n  } catch (e) { /* ignore — fall back to system menu */ }\n  // Wait for header visible dropdown debug info to include Game Master\n  // This ensures the test doesn't race with header rendering logic.\n  try {\n    await page.waitForFunction((k) => {\n      try {\n        const raw = window.localStorage.getItem(k as string);\n        if (!raw) return false;\n        const parsed = JSON.parse(raw);\n        return Array.isArray(parsed.items) && parsed.items.includes('game-master');\n      } catch (e) { return false; }\n    }, 'wonky-e2e-visible-dropdown', { timeout: 3000 });\n  } catch (e) {\n    // No-op — fallbacks below will try system menu and dispatch\n  }\n  // Open Game Master Hub\n  try {\n    const gmHub = page.getByText('Game Master Hub');\n    if ((await gmHub.count()) > 0) {\n      await retryClick(gmHub, { tries: 3 });\n    } else {\n      throw new Error('Game Master Hub not present');\n    }\n  } catch (err) {\n    // fallback: open via system menu\n    try {\n      let systemBtn = page.getByTestId('nav-system');\n      if (await systemBtn.count()) {\n        await retryClick(systemBtn, { tries: 3 });\n        await page.getByRole('menu').waitFor({ state: 'visible', timeout: 5000 });\n        const gmMenu = page.getByRole('menuitem', { name: /Game Master Hub/i });\n        await retryClick(gmMenu, { tries: 3 });\n      }\n    } catch (e) {\n      // If clicking the System menu or its items fails, swallow the error\n      // and continue to the dispatch fallback below.\n      console.warn('Could not open Game Master via System menu', e);\n    }\n    // If the header still doesn't show Game Master Hub, call the E2E test dispatch\n    // to set the dashboard type and open the Game Master dashboard directly.\n    try {\n      const didDispatch = await page.evaluate(() => {\n        try {\n          const dispatch = (window as any).__WONKY_TEST_DISPATCH__;\n          if (!dispatch) return false;\n          // Ensure the allowed dashboard type for the Game Master is set\n          dispatch({ type: 'SET_DASHBOARD_TYPE', payload: 'william' });\n          // Open the Game Master dashboard directly\n          // If tests have an active E2E forced view, clear it so dispatch\n          // can take effect (AppContent prefers __E2E_FORCE_VIEW__ over\n          // app state when present). We set it to undefined rather than\n          // reload so we don't lose other runtime state.\n          if ((window as any).__E2E_FORCE_VIEW__ === 'command-center') {\n            try { (window as any).__E2E_FORCE_VIEW__ = undefined; } catch (e) { /* ignore */ }\n          }\n          dispatch({ type: 'SET_VIEW', payload: 'game-master-dashboard' });\n          return true;\n        } catch (e) { return false; }\n      });\n      // Debug: whether dispatch exists and what view is set on the appState\n      try {\n        const debug = await page.evaluate(() => ({ testDispatch: !!(window as any).__WONKY_TEST_DISPATCH__, view: (window as any).appState?.view }));\n        console.log('WONKY_FALLBACK_DEBUG', debug);\n      } catch (e) { console.warn('FALLBACK_DEBUG_FAILED', e); }\n      if (didDispatch) {\n        // After dispatch, ensure the runtime app state reflects the new view\n        const newView = await page.evaluate(() => (window as any).appState?.view || null);\n        console.log('WONKY_FALLBACK_VIEW_AFTER_DISPATCH', newView);\n        // Release the E2E gate after dispatch forces the Game Master view so\n        // the test can interact with the UI. This covers cases where the\n        // header debug never included the Game Master item but the dispatch\n        // fallback still succeeded.\n        try { await page.evaluate(() => { (window as any).__WONKY_TEST_READY__ = true; }); } catch (e) { /* ignore */ }\n        // Wait for the admin content to become visible\n        try {\n          try { await page.evaluate(() => { (window as any).__WONKY_TEST_READY__ = true; }); } catch (e) { /* ignore */ }\n          try { await page.waitForSelector('[data-testid=\"e2e-gate\"]', { state: 'detached', timeout: 3000 }); } catch (e) { /* ignore */ }\n          await expect(page.getByTestId('pending-redemptions')).toBeVisible({ timeout: 10000 });\n          // Allow DB updates once we've verified the seeded content is visible\n          try { await page.evaluate(() => { try { (window as any).__WONKY_TEST_ALLOW_DB_UPDATES__(true); } catch (e) { /* ignore */ } }); } catch(e) { /* ignore */ }\n        } catch (e) {\n          // If the dispatch route didn't reveal the Game Master dashboard,\n          // fall back to reseeding the storage key and reloading the page.\n          try {\n            await page.evaluate((key) => {\n              try {\n                const state = JSON.parse(window.localStorage.getItem(key as string) || '{}');\n                state.dashboardType = 'william';\n                state.view = 'game-master-dashboard';\n                state.initialSetupComplete = true;\n                window.localStorage.setItem(key, JSON.stringify(state));\n              } catch (e) { /* ignore */ }\n            }, storageKey);\n            // Ensure the forced view is applied when the page initializes.\n            await page.addInitScript(() => { try { (window as any).__E2E_FORCE_VIEW__ = 'game-master-dashboard'; } catch (e) { /* ignore */ } });\n            await page.reload({ waitUntil: 'load' });\n            // After reload, the initial addInitScript might set __E2E_FORCE_VIEW__\n            // back to 'command-center' — override it here to force the admin\n            // view for this test run and trigger a re-render.\n            try {\n              await page.evaluate(() => { try { (window as any).__E2E_FORCE_VIEW__ = 'game-master-dashboard'; } catch(e) { /* ignore */ } });\n            } catch(e) { /* ignore */ }\n            await page.waitForLoadState('networkidle');\n            // Ensure the app view is the Game Master dashboard before proceeding\n            try { await ensureAppView(page, 'game-master-dashboard', 5); } catch (_) { /* ignore */ }\n            try { await page.evaluate(() => { (window as any).__WONKY_TEST_READY__ = true; }); } catch (e) { /* ignore */ }\n            try { await page.waitForSelector('[data-testid=\"e2e-gate\"]', { state: 'detached', timeout: 3000 }); } catch (e) { /* ignore */ }\n            await expect(page.getByTestId('pending-redemptions')).toBeVisible({ timeout: 10000 });\n          } catch (err) { /* final fallback ignored */ }\n        }\n      }\n    } catch (e) { /* ignore dispatch fallback errors */ }\n  }\n\n  // Ensure the Redemption Hub shows the pending item\n  try { await page.evaluate(() => { (window as any).__WONKY_TEST_READY__ = true; }); } catch (e) { /* ignore */ }\n  try { await page.waitForSelector('[data-testid=\"e2e-gate\"]', { state: 'detached', timeout: 3000 }); } catch (e) { /* ignore */ }\n  await expect(page.getByTestId('pending-redemptions')).toBeVisible({ timeout: 10000 });\n  try { await page.evaluate(() => { try { (window as any).__WONKY_TEST_ALLOW_DB_UPDATES__(true); } catch (e) { /* ignore */ } }); } catch(e) { /* ignore */ }\n  // Enter a note and click 'Mark as Fulfilled' (use stable testids)\n  // Determine the persona who has the pending redemption so we don't rely on\n  // literal 'willow' in the test. We check `window.appState` (exposed by the\n  // App) first; fallback to localStorage if not set.\n  const persona = await page.evaluate(() => {\n    try {\n      const key = (window as any).__E2E_STORAGE_KEY__ || 'wonky-sprout-os-state';\n      const state = (window as any).appState || JSON.parse(window.localStorage.getItem(key) || '{}');\n      if (state && state.redeemedRewards) {\n        for (const key of Object.keys(state.redeemedRewards)) {\n          if (Array.isArray(state.redeemedRewards[key]) && state.redeemedRewards[key].includes(5)) return key;\n        }\n      }\n    } catch (e) { /* ignore */ }\n    return 'willow';\n  });\n  const redemptionId = `${persona}-5`;\n  const pendingNote = page.getByTestId(`redemption-note-${redemptionId}`);\n  await pendingNote.fill('Fulfilled by admin in test');\n  const pendingBtn = page.getByTestId(`mark-fulfilled-${redemptionId}`);\n  await pendingBtn.click();\n\n  // The fulfillment should appear in the Fulfillment Log\n  await expect(page.getByText(/Fulfillment Log/)).toBeVisible();\n  await expect(page.locator('text=Fulfilled by admin in test')).toBeVisible({ timeout: 10000 });\n  try {\n    if (shouldTrace) await page.context().tracing.stop({ path: 'trace-redemption_admin.zip' });\n  } catch (e) { console.warn('Failed to stop tracing', e); }\n  // Cleanup the seeded state for this worker so following tests aren't affected\n  try { await page.evaluate((key) => { try { window.localStorage.removeItem(key as string); } catch (e) { /* ignore */ } }, storageKey); } catch (e) { /* ignore */ }\n});\n```