name: Discord Integration Tests (Auto)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  run-integration-tests:
    runs-on: ubuntu-latest
    env:
      REDIS_URL: ${{ secrets.REDIS_URL || 'redis://localhost:6379' }}
      DISCORD_SERVICE_BOT_TOKEN: ${{ secrets.DISCORD_SERVICE_BOT_TOKEN }}
      DISCORD_TEST_GUILD_ID: ${{ secrets.DISCORD_TEST_GUILD_ID }}
      DISCORD_TEST_VOICE_CHANNEL_ID: ${{ secrets.DISCORD_TEST_VOICE_CHANNEL_ID }}
    # Only run if secrets exist for Discord integration
    if: ${{ secrets.DISCORD_SERVICE_BOT_TOKEN != '' && secrets.DISCORD_TEST_GUILD_ID != '' && secrets.DISCORD_TEST_VOICE_CHANNEL_ID != '' }}
    services:
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Install dependencies (including Discord optional dependencies)
        run: |
          npm ci
          npm install --no-save discord.js @discordjs/voice google-tts-api tweetnacl ioredis node-fetch@2
      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
      - name: Start Discord bot worker in background
        run: |
          nohup npm run start:discord-bot > discord-bot.log 2>&1 &
          sleep 3
      - name: Run Discord Integration Tests
        env:
          DISCORD_INTEGRATION_TEST: "true"
        run: npm run test:discord-integration
